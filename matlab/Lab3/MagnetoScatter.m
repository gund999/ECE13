% Define data points
XYZ = [
 461, -3, -650;
 465, 0, -643;
 469, -2, -647;
 477, -6, -655;
 465, -8, -650;
 447, -12, -643;
 449, -7, -640;
 453, 0, -637;
 455, -4, -634;
 459, -12, -632;
 459, -14, -634;
 454, -16, -637;
 444, -14, -637;
 438, -12, -637;
 445, -12, -637;
 449, -12, -638;
 442, -12, -640;
 437, -9, -643;
 442, -4, -643;
 447, -4, -645;
 447, -14, -650;
 447, -19, -652;
 447, -9, -647;
 448, -2, -643;
 450, -4, -643;
 457, 3, -647;
 462, 12, -652;
 465, 24, -652;
 465, 31, -650;
 465, 41, -649;
 465, 48, -649;
 469, 38, -646;
 474, 24, -644;
 486, 33, -643;
 495, 49, -643;
 490, 44, -650;
 481, 30, -655;
 490, 15, -647;
 500, 11, -643;
 500, 11, -635;
 500, 11, -631;
 492, -2, -634;
 488, -12, -637;
 495, -19, -640;
 500, -24, -643;
 510, -9, -632;
 518, 0, -625;
 518, -14, -632;
 466, -18, -634;
 459, 0, -627;
 510, 8, -620;
 525, 19, -605;
 526, 21, -599;
 515, 18, -596;
 510, 18, -601;
 507, 21, -619;
 508, 26, -621;
 515, 37, -610;
 515, 35, -613;
 508, 17, -631;
 502, 20, -629;
 491, 35, -619;
 495, 32, -616;
 506, 29, -613;
 498, 40, -615;
 488, 58, -619;
 492, 55, -614;
 500, 52, -607;
 490, 56, -614;
 477, 64, -625;
 481, 73, -620;
 488, 88, -609;
 481, 94, -602;
 478, 112, -588;
 492, 126, -576;
 513, 146, -544;
 527, 158, -505;
 545, 161, -450;
 555, 145, -416;
 570, 123, -363;
 582, 111, -327;
 600, 75, -272;
 612, 28, -236;
 619, -40, -186;
 609, -85, -159;
 591, -191, -116;
 575, -252, -99;
 530, -299, -83;
 502, -315, -75;
 464, -356, -57;
 441, -389, -43;
 387, -403, -26;
 345, -401, -16;
 298, -402, 0;
 272, -404, 12;
 231, -406, 27;
 203, -406, 37;
 174, -394, 49;
 160, -382, 54;
 160, -345, 64;
 165, -324, 72;
 193, -285, 87;
 212, -259, 97;
 243, -195, 85;
 265, -153, 78;
 286, -135, 78;
 300, -124, 78;
 303, -92, 82;
 306, -71, 83;
 313, -81, 79;
 326, -100, 80;
 350, -135, 88;
 357, -164, 86;
 354, -218, 71;
 356, -246, 63;
 367, -278, 56;
 373, -293, 55;
 380, -307, 58;
 387, -305, 56;
 401, -284, 45;
 407, -272, 46;
 410, -257, 61;
 409, -246, 58;
 402, -236, 48;
 412, -240, 48;
 430, -247, 48;
 427, -261, 43;
 424, -283, 36;
 433, -304, 19;
 447, -336, -6;
 454, -347, -27;
 465, -365, -60;
 469, -395, -82;
 477, -454, -130;
 467, -480, -162;
 448, -513, -214;
 439, -527, -255;
 419, -543, -327;
 398, -548, -388;
 360, -546, -481;
 327, -532, -547;
 280, -500, -628;
 252, -465, -660;
 214, -418, -701;
 195, -394, -721;
 170, -361, -748;
 156, -342, -755;
 125, -291, -754;
 108, -258, -749;
 76, -211, -756;
 53, -180, -766;
 39, -134, -771;
 37, -104, -771;
 21, -70, -766;
 7, -51, -761;
 -2, -72, -749;
 -4, -102, -739;
 -3, -155, -736;
 -1, -193, -738;
 16, -258, -736;
 33, -289, -734;
 70, -327, -723;
 89, -353, -716;
 166, -360, -716;
 218, -365, -716;
 317, -336, -686;
 383, -318, -667;
 453, -247, -620;
 500, -200, -589;
 560, -161, -530;
 600, -141, -471;
 624, -159, -413;
 641, -176, -374;
 641, -212, -316;
 634, -231, -269;
 613, -252, -185;
 588, -260, -136;
 535, -263, -74;
 512, -246, -39;
 494, -189, 3;
 489, -126, 6;
 492, 7, -30;
 495, 86, -134;
 498, 188, -273;
 476, 230, -367;
 441, 241, -510;
 438, 203, -565;
 435, 146, -649;
 423, 115, -680;
 406, 70, -728;
 401, 34, -735;
 394, -18, -746;
 361, -86, -768;
 312, -189, -801;
 279, -217, -801;
 220, -262, -799;
 201, -269, -797;
 173, -291, -791;
 154, -319, -784;
 125, -358, -767;
 104, -382, -747;
 78, -417, -713;
 68, -441, -684;
 55, -482, -645;
 48, -517, -626;
 38, -561, -582;
 31, -577, -533;
 19, -596, -448;
 9, -598, -412;
 -4, -602, -369;
 -8, -604, -345;
 -13, -598, -296;
 -15, -591, -260;
 -19, -583, -234;
 -21, -579, -227;
 -18, -586, -236;
 -13, -595, -248;
 -29, -600, -301;
 -48, -600, -347;
 -67, -513, -490;
 -77, -478, -570;
 -57, -434, -639;
 -41, -383, -686;
 -44, -241, -726;
 -47, -147, -753;
 -15, -69, -763;
 6, -18, -771;
 24, 80, -741;
 36, 146, -722;
 60, 203, -704;
 77, 241, -672;
 56, 304, -614;
 -9, 353, -584;
 -55, 374, -551;
 -39, 378, -541;
 -53, 367, -544;
 -60, 368, -543;
 -67, 382, -536;
 -59, 398, -513;
 -27, 434, -451;
 -11, 472, -412;
 6, 550, -358;
 15, 597, -331;
 26, 660, -305;
 54, 721, -285;
 128, 781, -267;
 223, 802, -235;
 330, 834, -188;
 365, 834, -163;
 418, 834, -127;
 448, 822, -124;
 494, 805, -121;
 527, 805, -145;
 577, 805, -182;
 621, 783, -198;
 688, 752, -245;
 732, 719, -289;
 804, 644, -346;
 813, 592, -373;
 817, 522, -395;
 805, 487, -385;
 789, 430, -359;
 780, 388, -325;
 753, 328, -285;
 717, 293, -273;
 673, 252, -264;
 657, 240, -271;
 627, 230, -279;
 599, 232, -279;
 499, 256, -267;
 459, 277, -255;
 437, 323, -256;
 404, 358, -263;
 350, 392, -301;
 312, 408, -335;
 282, 426, -371;
 270, 435, -390;
 241, 428, -448;
 217, 416, -497;
 206, 382, -558;
 206, 354, -594;
 234, 253, -671;
 262, 218, -710;
 319, 181, -702;
 347, 135, -698;
 400, 96, -690;
 436, 70, -686;
 488, 52, -642;
 524, 41, -613;
 566, 19, -569;
 594, 5, -540;
 640, -33, -474;
 671, -59, -407;
 681, -129, -338;
 677, -198, -289;
 645, -261, -213;
 628, -294, -175;
 607, -329, -139;
 577, -361, -122;
 510, -421, -107;
 471, -442, -89;
 422, -445, -49;
 386, -444, -25;
 326, -437, 7;
 286, -438, 20;
 226, -449, 27;
 184, -436, 44;
 121, -412, 66;
 62, -400, 66;
 6, -383, 66;
 -19, -352, 70;
 -58, -306, 78;
 -81, -292, 73;
 -117, -271, 66;
 -147, -271, 56;
 -193, -271, 42;
 -207, -282, 37;
 -229, -300, 22;
 -231, -307, 8;
 -238, -315, -7;
 -245, -310, -9;
 -249, -309, -12;
 -245, -316, -12;
 -235, -320, -8;
 -223, -313, -1;
 -214, -310, 4;
 -221, -320, 2;
 -227, -333, -1;
 -225, -340, -3;
 -225, -351, -8;
 -230, -361, -13;
 -231, -371, -13;
 -224, -371, -8;
 -186, -352, 10;
 -156, -333, 27;
 -79, -319, 60;
 -18, -314, 84;
 92, -316, 101;
 172, -321, 106;
 296, -338, 63;
 381, -352, 17;
 459, -385, -69;
 494, -411, -132;
 519, -442, -254;
 526, -461, -315;
 462, -492, -388;
 445, -506, -437;
 438, -516, -513;
 406, -524, -564;
 289, -470, -666;
 212, -435, -734;
 102, -421, -756;
 30, -412, -771;
 -54, -436, -738;
 -111, -453, -716;
 -132, -456, -698;
 -146, -457, -688;
 -164, -454, -695;
 -180, -453, -682;
 -194, -453, -634;
 -209, -453, -608;
 -241, -453, -575;
 -261, -457, -560;
 -289, -472, -549;
 -305, -472, -537;
 -323, -457, -512;
 -330, -459, -499;
 -333, -477, -484;
 -336, -480, -467;
 -339, -473, -449;
 -338, -473, -441;
 -335, -477, -431;
 -332, -467, -431;
 -329, -453, -431;
 -333, -467, -416;
 -340, -488, -394;
 -335, -476, -384;
 -329, -459, -370;
 -338, -461, -355;
 -352, -465, -334;
 -354, -462, -333;
 -358, -461, -331;
 -355, -466, -329;
 -349, -469, -328;
 -344, -467, -331;
 -336, -468, -347;
 -329, -475, -373;
 -311, -481, -420;
 -287, -479, -462;
 -235, -477, -531;
 -179, -477, -587;
 -92, -472, -660;
 -31, -462, -694;
 59, -447, -725;
 118, -435, -723;
 217, -442, -710;
 257, -461, -698;
 283, -492, -667;
 290, -513, -643;
 306, -530, -626;
 318, -537, -621;
 338, -536, -594;
 352, -532, -570;
 363, -527, -546;
 368, -525, -534;
 380, -538, -513;
 389, -552, -499;
 401, -562, -459;
 408, -565, -437;
 415, -575, -407;
 418, -582, -388;
 425, -564, -370;
 430, -553, -358;
 436, -553, -358;
 441, -553, -358;
 444, -553, -368;
 447, -553, -376;
 422, -549, -430;
 406, -547, -492;
 402, -501, -569;
 404, -449, -604;
 419, -386, -633;
 440, -352, -632;
 489, -313, -599;
 517, -298, -581;
 553, -295, -559;
 566, -300, -542;
 569, -318, -513;
 575, -333, -480;
 589, -361, -411;
 594, -374, -377;
 594, -384, -344;
 588, -392, -307;
 570, -400, -267;
 555, -402, -233;
 541, -406, -182;
 524, -408, -155;
 500, -412, -115;
 493, -400, -93;
 483, -383, -60;
 480, -359, -43;
 477, -324, -18;
 467, -316, -1;
 453, -306, 24;
 455, -308, 24;
 469, -310, 12;
 490, -308, -12;
 520, -306, -53;
 536, -306, -87;
 563, -296, -136;
 584, -277, -168;
 614, -233, -214;
 630, -181, -243;
 644, -120, -274;
 639, -101, -276;
 636, -74, -259;
 638, -58, -239;
 637, -48, -213;
 630, -55, -196;
 616, -40, -183;
 609, -21, -178;
 603, 2, -188;
 601, 16, -200;
 595, 55, -210;
 590, 88, -215;
 574, 140, -240;
 560, 175, -262;
 534, 233, -294;
 515, 273, -316;
 458, 316, -407;
 411, 340, -461;
 293, 327, -563;
 230, 311, -631;
 131, 265, -682;
 65, 235, -716;
 -55, 196, -723;
 -135, 170, -728;
 -163, 71, -724;
 -182, 5, -722;
 -213, -58, -707;
 -235, -100, -698;
 -231, -195, -687;
 -221, -288, -673;
 -200, -376, -655;
 -176, -423, -651;
 -127, -476, -659;
 -87, -502, -664;
 -17, -526, -671;
 24, -532, -675;
 81, -526, -678;
 116, -528, -678;
 166, -542, -675;
 198, -544, -677;
 243, -537, -688;
 255, -465, -704;
 245, -408, -723;
 242, -399, -751;
 242, -336, -795;
 260, -220, -795;
 289, -48, -795;
 333, 18, -751;
 400, 117, -686;
 437, 135, -644;
 494, 164, -583;
 546, 128, -539;
 624, 76, -454;
 633, 50, -418;
 651, -10, -363;
 661, -52, -327;
 663, -113, -275;
 649, -151, -243;
 634, -203, -207;
 632, -231, -197;
 628, -248, -185;
 626, -227, -180;
 625, -192, -178;
 627, -164, -183;
 631, -132, -200;
 633, -125, -224;
 632, -167, -270;
 628, -217, -292;
 614, -296, -315;
 604, -350, -327;
 578, -412, -324;
 557, -447, -314;
 516, -491, -294;
 486, -517, -280;
 433, -565, -251;
 395, -600, -229;
 339, -627, -210;
 301, -636, -203;
 228, -648, -218;
 174, -655, -230;
 62, -648, -259;
 6, -641, -279;
 -78, -627, -286;
 -135, -618, -291;
 -184, -586, -324;
 -217, -565, -346;
 -262, -529, -331;
 -293, -506, -322;
 -314, -470, -318;
 -329, -447, -316;
 -335, -429, -293;
 -340, -412, -274;
 -337, -394, -259;
 -336, -383, -256;
 -339, -369, -259;
 -328, -380, -263;
 -293, -425, -270;
 -256, -463, -269;
 -178, -530, -258;
 -113, -569, -246;
 3, -618, -220;
 79, -638, -209;
 192, -649, -202;
 248, -641, -192;
 305, -605, -182;
 352, -563, -157;
 394, -518, -121;
 408, -482, -94;
 430, -430, -54;
 430, -399, -34;
 430, -353, -6;
 401, -339, 25;
 359, -318, 72;
 351, -306, 77;
 341, -289, 85;
 345, -270, 87;
 353, -226, 89;
 365, -195, 87;
 384, -147, 86;
 386, -112, 88;
 392, -55, 86;
 402, -13, 76;
 417, 24, 57;
 429, 14, 40;
 454, -2, 21;
 480, -16, 16;
 520, -43, -11;
 548, -69, -57;
 585, -116, -125;
 601, -158, -147;
 618, -237, -194;
 618, -275, -230;
 608, -338, -270;
 598, -383, -292;
 558, -438, -313;
 523, -471, -323;
 501, -500, -335;
 496, -512, -342;
 498, -515, -334;
 503, -513, -322;
 522, -495, -296;
 538, -479, -276;
 575, -351, -223;
 603, -271, -194;
 628, -105, -263;
 635, 5, -309;
 582, 30, -473;
 547, 47, -583;
 483, -80, -674;
 441, -165, -735;
 391, -246, -749;
 359, -300, -759;
 348, -346, -737;
 341, -377, -721;
 288, -415, -717;
 237, -448, -717;
 192, -469, -721;
 157, -484, -715;
 97, -505, -693;
 74, -513, -683;
 67, -516, -676;
 78, -512, -680;
 117, -494, -698;
 148, -478, -704;
 205, -450, -704;
 255, -416, -706;
 351, -342, -711;
 427, -245, -693;
 494, -136, -668;
 520, -77, -634;
 559, 11, -583;
 537, 81, -561;
 506, 188, -528;
 484, 225, -491;
 453, 282, -437;
 413, 317, -412;
 353, 370, -376;
 322, 374, -332;
 277, 370, -220;
 213, 346, -128;
 116, 299, -16;
 114, 252, 21;
 122, 168, 71;
 143, 95, 93;
 174, -14, 119;
 193, -89, 129;
 212, -202, 129;
 212, -277, 110;
 209, -376, 77;
 204, -423, 50;
 196, -536, 2;
 189, -564, -19;
 178, -550, -46;
 173, -560, -63;
 194, -553, -64;
 218, -541, -57;
 265, -525, -58;
 300, -516, -63;
 384, -490, -95;
 450, -469, -124;
 527, -428, -209;
 571, -398, -280;
 587, -349, -461;
 580, -316, -556;
 513, -258, -658;
 449, -230, -729;
 375, -198, -765;
 347, -177, -789;
 312, -162, -792;
 289, -153, -795;
 289, -118, -799;
 289, -95, -802;
 295, -31, -816;
 300, 11, -826;
 310, 14, -826;
 318, 17, -832;
 339, 13, -850;
 360, 7, -863;
 381, -2, -885;
 384, -19, -895;
 374, -58, -902;
 369, -75, -909;
 366, -90, -924;
 366, -93, -932;
 369, -90, -943;
 372, -74, -948;
 375, -32, -951;
 378, -19, -957;
 381, -22, -965;
 381, -7, -965;
 378, 17, -966;
 381, 14, -963;
 388, 11, -960;
 383, 25, -945;
 377, 47, -923;
 369, 79, -913;
 359, 129, -899;
 340, 135, -891;
 312, 146, -881;
 274, 144, -878;
 218, 141, -873;
 215, 143, -871;
 220, 119, -875;
 236, 65, -887;
 257, 7, -897;
 267, 0, -895;
 275, -1, -896;
 273, 7, -903;
 266, 21, -914;
 256, 31, -921;
 230, 36, -929;
 197, 26, -929;
 154, 8, -923;
 133, -7, -911;
 109, -35, -891;
 104, -47, -884;
 114, -65, -881;
 128, -77, -881;
 138, -106, -866;
 140, -130, -851;
 158, -160, -841;
 174, -179, -839;
 168, -191, -828;
 154, -193, -818;
 145, -184, -811;
 143, -175, -809;
 139, -185, -815;
 137, -199, -820;
 128, -258, -801;
 124, -294, -789;
 103, -375, -730;
 89, -430, -692;
 99, -507, -615;
 106, -559, -565;
 141, -594, -499;
 165, -618, -455;
 221, -603, -419;
 259, -594, -377;
 354, -555, -326;
 439, -510, -293;
 502, -450, -245;
 532, -417, -220;
 556, -378, -191;
 556, -370, -177;
 532, -388, -162;
 525, -405, -166;
 528, -441, -196;
 531, -453, -253;
 534, -453, -395;
 519, -431, -539;
 474, -368, -674;
 429, -323, -726;
 341, -289, -814;
 227, -298, -823;
 100, -312, -838;
 76, -319, -835;
 42, -330, -832;
 60, -330, -839;
 89, -330, -850;
 171, -334, -828;
 294, -341, -796;
 376, -353, -728;
 500, -371, -582;
 535, -382, -494;
 584, -402, -376;
 577, -407, -315;
 571, -412, -246;
 571, -412, -229;
 576, -406, -214;
 588, -394, -219;
 602, -379, -241;
 607, -372, -275;
 615, -358, -335;
 622, -344, -389;
 613, -319, -530;
 580, -298, -603;
 483, -255, -695;
 419, -234, -766;
 341, -172, -862;
 294, -120, -923;
 228, -29, -983;
 186, 37, -1012;
 139, 110, -995;
 113, 150, -963;
 72, 198, -904;
 44, 226, -860;
 1, 283, -806;
 -26, 325, -774;
 -78, 409, -660;
 -116, 452, -595;
 -184, 441, -496;
 -217, 435, -431;
 -217, 406, -292;
 -217, 387, -200;
 -174, 306, -94;
 -146, 252, -24;
 -114, 188, 30;
 -94, 146, 66;
 -72, 79, 73;
 -58, 35, 80;
 -68, -7, 83;
 -84, -50, 83;
 -108, -92, 79;
 -130, -108, 69;
 -169, -115, 44;
 -199, -107, 21;
 -252, -75, -21;
 -281, -42, -44;
 -317, 24, -69;
 -331, 65, -97;
 -337, 122, -156;
 -344, 149, -213;
 -359, 173, -326;
 -355, 158, -446;
 -331, 123, -571;
 -283, 52, -636;
 -223, -53, -735;
 -161, -121, -747;
 -70, -224, -765;
 -18, -275, -753;
 59, -353, -735;
 113, -383, -710;
 194, -430, -674;
 227, -446, -637;
 277, -471, -567;
 314, -477, -535;
 381, -487, -476;
 402, -485, -420;
 435, -474, -332;
 459, -457, -269;
 487, -416, -181;
 496, -367, -133;
 510, -295, -75;
 520, -250, -55;
 531, -166, -32;
 533, -86, -25;
 535, 14, -26;
 535, 54, -43;
 543, 84, -67;
 560, 74, -74;
 586, -10, -95;
 595, -90, -112;
 616, -198, -172;
 632, -266, -223;
 619, -352, -329;
 598, -404, -409;
 531, -413, -509;
 475, -396, -570;
 400, -378, -625;
 353, -369, -649;
 299, -252, -760;
 268, -191, -826;
 179, 10, -833;
 130, 158, -838;
 105, 246, -787;
 89, 305, -753;
 95, 323, -680;
 100, 335, -632;
 125, 335, -613;
 142, 335, -601;
 163, 331, -593;
 177, 329, -581;
 187, 329, -560;
 194, 327, -549;
 201, 324, -537;
 208, 330, -525;
 215, 351, -500;
 223, 351, -492;
 241, 330, -492;
 243, 328, -496;
 233, 346, -511;
 232, 346, -519;
 239, 328, -530;
 240, 327, -536;
 237, 341, -543;
 236, 344, -543;
 236, 341, -540;
 238, 340, -547;
 242, 340, -559;
 242, 333, -551;
 242, 323, -540;
 244, 323, -542;
 247, 323, -547;
 240, 320, -549;
 230, 317, -552;
 239, 328, -544;
 253, 346, -536;
 248, 329, -541;
 240, 308, -548;
 238, 315, -553;
 236, 325, -556;
 236, 330, -551;
 233, 335, -547;
 228, 335, -549;
 227, 331, -553;
 234, 324, -556;
 242, 321, -556;
 242, 330, -551;
 239, 337, -548;
 234, 333, -553;
 231, 329, -550;
 233, 329, -543;
 240, 335, -544
];


% Separate column vectors
X = XYZ(:, 1);
Y = XYZ(:, 2);
Z = XYZ(:, 3);


[Atilde,Btilde] = CalibrateEllipsoidData3D(X,Y,Z,20,1);
[Xcorr,Ycorr,Zcorr] = CorrectEllipsoidData3D(X,Y,Z,Atilde,Btilde);

% Plot in 3D
scatter3(Xcorr, Ycorr, Zcorr);
xlabel('X');
ylabel('Y');
zlabel('Z');
title('Scatter Plot of XYZ Magnetometer Data');